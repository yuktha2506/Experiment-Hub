<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forgot Password - ExperimentHub</title>
  <link rel="icon" href="pic.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
<div id="file-notice" style="display:none; background:#ff9800; color:#000; padding:12px 20px; text-align:center; font-weight:600;">
  Run the server first: open terminal in the <strong>public</strong> folder and run <code>node server.js</code>, then open <a href="http://localhost:3000/forgotten-password.html" style="color:#000; text-decoration:underline;">http://localhost:3000/forgotten-password.html</a>
</div>
<script>if (window.location.protocol === "file:") { document.getElementById("file-notice").style.display = "block"; }</script>
<div class="container">
  <div class="auth-container">
    <div class="auth-box">

      <h1 class="logo">ExperimentHub</h1>
      <p class="subtitle">Password Recovery</p>

      <!-- STEP 1 : EMAIL -->
      <div id="step-email" class="form-container active">
        <h2>Forgot Password</h2>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" placeholder="Enter your registered email">
        </div>

        <button class="btn btn-primary" onclick="sendOTP()">Send OTP</button>
      </div>

      <!-- STEP 2 : OTP -->
      <div id="step-otp" class="form-container">
        <h2>Verify OTP</h2>

        <div class="form-group">
          <label>OTP</label>
          <input type="text" id="otp" placeholder="Enter 6-digit OTP">
        </div>

        <button class="btn btn-primary" onclick="verifyOTP()">Verify OTP</button>
      </div>

      <!-- STEP 3 : RESET PASSWORD -->
      <div id="step-reset" class="form-container">
        <h2>Set New Password</h2>

        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPassword" placeholder="Enter new password">
        </div>

        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm new password">
        </div>

        <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
      </div>

      <div id="message" class="message"></div>

      <p class="toggle-text">
        <a href="student-login.html">← Back to Login</a>
      </p>

    </div>

    <!-- INFO BOX -->
    <div class="info-box">
      <div class="illustration-container">
        <h3>Password Recovery</h3>
      </div>
      <p>
        Enter your registered email to receive a one-time password (OTP).
        This helps you securely reset your password.
      </p>
      <ul class="features">
        <li>✓ Secure OTP verification</li>
        <li>✓ Gmail based recovery</li>
        <li>✓ Works for Students & Staff</li>
      </ul>
    </div>

  </div>
</div>

<script>
let userEmail = "";

// Use server URL when page is opened from file (file://) so API calls reach Node server
var API_BASE = (window.location.protocol === "http:" || window.location.protocol === "https:") ? "" : "http://localhost:3000";

/* STEP 1 */
function sendOTP() {
  const email = document.getElementById("email").value.trim();
  const message = document.getElementById("message");

  if (!email) {
    message.className = "message error";
    message.textContent = "Please enter email";
    return;
  }

  fetch(API_BASE + "/api/forgot-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      userEmail = email;
      showStep("step-otp");
      message.className = "message success";
      message.textContent = data.message || "OTP sent to your email";
    } else {
      message.className = "message error";
      message.textContent = data.message || "Failed to send OTP";
    }
  })
  .catch(() => {
    message.className = "message error";
    message.textContent = "Cannot reach server. Run: cd public && node server.js then open http://localhost:3000/forgotten-password.html";
  });
}

/* STEP 2 */
function verifyOTP() {
  const otp = document.getElementById("otp").value.trim();
  const message = document.getElementById("message");

  if (!otp) {
    message.className = "message error";
    message.textContent = "Enter OTP";
    return;
  }

  fetch(API_BASE + "/api/verify-otp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: userEmail, otp })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showStep("step-reset");
      message.className = "message success";
      message.textContent = "OTP verified. Set new password.";
    } else {
      message.className = "message error";
      message.textContent = data.message || "Invalid or expired OTP";
    }
  })
  .catch(err => {
    message.className = "message error";
    message.textContent = "Error verifying OTP. Please try again.";
  });
}

/* STEP 3 */
function resetPassword() {
  const newPassword = document.getElementById("newPassword").value;
  const confirm = document.getElementById("confirmPassword").value;
  const otp = document.getElementById("otp").value;
  const message = document.getElementById("message");

  if (newPassword !== confirm) {
    message.className = "message error";
    message.textContent = "Passwords do not match";
    return;
  }

  fetch(API_BASE + "/api/reset-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: userEmail,
      otp,
      newPassword
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      message.className = "message success";
      message.textContent = "Password reset successful! Redirecting...";
      setTimeout(() => {
        window.location.href = "student-login.html";
      }, 1500);
    } else {
      message.className = "message error";
      message.textContent = data.message;
    }
  });
}

function showStep(stepId) {
  document.querySelectorAll(".form-container").forEach(div => {
    div.classList.remove("active");
  });
  document.getElementById(stepId).classList.add("active");
}
</script>

</body>
</html>
